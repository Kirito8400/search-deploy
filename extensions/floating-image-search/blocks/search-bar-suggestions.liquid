<link
  rel="stylesheet"
  href="https://cdn.shopify.com/s/files/1/0723/1966/4307/files/search-suggestions.css?v=1752751834"
>

<section class="block-{{ block.id }} vs-sg-search-suggestions-wrapper">
  <div class="vs-sg-search-suggestions">
    <div class="vs-sg-search-suggestions-container">
      <div class="vs-sg-recent-search-query" style="">
        <h3 style="">Recent Searches</h3>
        <div
          class="vs-sg-recent-search-query-items"
          style="
            margin-bottom: 2rem;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
          "
        >
          <span class="vs-sg-query-item">Merino Wool Socks</span>
        </div>
      </div>
      <div id="vs-sg-popular-query" class="vs-sg-popular-query">
        <h3>Popular Query</h3>
        <div class="vs-sg-popular-query-grid">
          <span class="vs-sg-query-item">Merino Wool Socks</span>
          <span class="vs-sg-query-item">Merino Wool Socks Mid Length</span>
          <span class="vs-sg-query-item">Merino Wool Socks Full Length</span>
          <span class="vs-sg-query-item">Cotton Work Socks Mid Length (Pack of 3)</span>
          <span class="vs-sg-query-item">Hybrid Vest</span>
          <span class="vs-sg-query-item">Hose Down T-shirt</span>
          <span class="vs-sg-query-item">Hose Down Shorts</span>
          <span class="vs-sg-query-item">Cotton Work Socks Full Length (Pack of 3)</span>
          <span class="vs-sg-query-item">Monsoon Nunatak Smock</span>
          <span class="vs-sg-query-item">Baseline Pull-on Zip Top</span>
          <span class="vs-sg-query-item">Ballistic Fleece Hoodie</span>
        </div>
      </div>

      <div id="vs-sg-popular-search-products" class="vs-sg-popular-search-products">
        <h3>Popular Search Product Images</h3>
        <div class="vs-sg-popular-products-grid">
          <!-- Dynamic popular product's images will be inserted here -->
        </div>
      </div>

      <!-- Dynamic search results section -->
      <div class="vs-sg-dynamic-search-results" style="display: none;">
        <h3>Products</h3>
        <div class="vs-sg-dynamic-products-grid">
          <!-- Dynamic products will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Parse metafield settings
    const metaField = {{ shop.metafields.vs_settings_namespace.vs_settings_key }};
    const settings = typeof metaField === 'string' ? JSON.parse(metaField) : metaField;

    // Dynamic CONFIG object with metafield overrides
    const CONFIG = {
      searchDelay: {{ block.settings.search_delay | default: 300 }},
      enableDynamicSearch: {{ block.settings.enable_dynamic_search | default: true }},
      showPopularQueries: settings?.SearchRecommendationsSettings?.hotKeywords ?? {{ block.settings.show_popular_queries | default: true }},
      showPopularProducts: settings?.ProductImageSearch?.popularImageSearch ?? {{ block.settings.show_popular_products | default: true }},
      maxSearchResults: settings?.AllSettings?.RecommendedImageSearchPerRow ?? 6,
      imageAspectRatio: settings?.AllSettings?.RecommendedImageAspectRatio ?? 'portrait',
      imageBorderRadius: settings?.AllSettings?.RecommendedImageBorderRadius ?? 4,
      showRecentSearches: settings?.SearchRecommendationsSettings?.showRecentSearches ?? true,
      recentSearchInterval: parseInt(settings?.SearchRecommendationsSettings?.recentSearchInterval ?? '7'),
      placeholderImage: 'https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png'
    };

    // DOM Elements
    const suggestionsWrapper = document.querySelector('.vs-sg-search-suggestions-wrapper');
    const searchForms = document.querySelectorAll('header form[action="/search"]');
    console.log("Suggestions wrapper:", suggestionsWrapper);
    console.log("Search forms:", searchForms);

    if (!suggestionsWrapper || searchForms.length === 0) return;

    // Initialize search suggestions for each search form
    searchForms.forEach(form => initializeSearchSuggestions(form));

    // Remove the original template element after cloning
    suggestionsWrapper.remove();

    /**
     * Apply dynamic settings based on CONFIG object
     */
    function applyDynamicSettings() {
      console.log("Applying dynamic settings...")
      // Apply image styling based on settings
      suggestionsWrapper.querySelectorAll('.vs-sg-popular-products-grid img').forEach(img => {
        img.style.aspectRatio = CONFIG.imageAspectRatio;
        img.style.borderRadius = `${CONFIG.imageBorderRadius}px`;
      });

      // Hide/show sections based on settings
      if (!CONFIG.showPopularQueries) {
        console.log("Hiding popular queries...")
        const popularQuery = suggestionsWrapper.querySelector('.vs-sg-popular-query');
        console.log("Popular query:", popularQuery);
        popularQuery.classList.add('hidden');
      }
      if (!CONFIG.showPopularProducts) {
        document.querySelector('.vs-sg-popular-search-products').style.display = 'none';
      }
      if (!CONFIG.showRecentSearches) {
        document.querySelector('.vs-sg-recent-search-query').style.display = 'none';
      }
    }

    // Call the function to apply dynamic settings
    applyDynamicSettings();
})
</script>

{% schema %}
{
  "name": "Search Suggestions",
  "target": "body",
  "stylesheet": "search-suggestions.css",
  "javascript": "search-bar-suggestions.js",
  "settings": []
}
{% endschema %}
